<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>星座人格實驗｜心理測驗</title>
  <meta name="description" content="一場心理學實驗：你相信星座嗎？這個網站讓你體驗為什麼我們覺得星座分析『很準』。">
  <meta name="keywords" content="星座測驗,心理學實驗,星座人格,心理測驗,星座分析,星座性格,人格測試">
  <meta name="author" content="星座人格實驗">
  <meta name="robots" content="index, follow">
  
  <!-- Google Search Console Verification -->
  <meta name="google-site-verification" content="l-fEHYonQavlh9KlKoLMVreyAKSoukHloQ0_SkqrfY0" />
  
  <!-- Open Graph Tags -->
  <meta property="og:title" content="星座人格實驗｜心理測驗">
  <meta property="og:description" content="一場心理學實驗：你相信星座嗎？這個網站讓你體驗為什麼我們覺得星座分析『很準』。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://your-username.github.io/zodiac-experiment/">
  <meta property="og:image" content="" id="dynamic-og-image">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="星座人格實驗">
  <meta property="og:locale" content="zh_TW">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="星座人格實驗｜心理測驗">
  <meta name="twitter:description" content="一場心理學實驗：你相信星座嗎？這個網站讓你體驗為什麼我們覺得星座分析『很準』。">
  <meta name="twitter:image" content="" id="dynamic-twitter-image">
  <meta name="twitter:site" content="@zodiac_experiment">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "星座人格實驗｜心理測驗",
    "description": "一場心理學實驗：你相信星座嗎？這個網站讓你體驗為什麼我們覺得星座分析『很準』。",
    "applicationCategory": "PsychologyApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "TWD"
    },
    "author": {
      "@type": "Organization",
      "name": "星座人格實驗"
    },
    "audience": {
      "@type": "PeopleAudience",
      "suggestedMinAge": 13,
      "suggestedMaxAge": 100
    }
  }
  </script>
  
  <!-- 引入 Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <style>
    :root {
      --primary: #6a5acd;
      --secondary: #9370db;
      --accent: #ba55d3;
      --light: #f0f4f8;
      --dark: #333;
      --success: #4caf50;
      --warning: #ff9800;
      --error: #e74c3c;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* 優化星空背景 */
    .stars-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, #0b0b2d 0%, #1a1a4a 50%, #2d1a4a 100%);
      overflow: hidden;
    }
    
    .background-star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 5s) infinite var(--delay, 0s);
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    
    /* 星座連線效果 */
    .constellation {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }
    
    .constellation-line {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transform-origin: left center;
      animation: linePulse 8s infinite;
    }
    
    @keyframes linePulse {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.5; }
    }
    
    /* 流星效果 */
    .shooting-star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 10px 2px white;
      opacity: 0;
    }
    
    @keyframes shoot {
      0% {
        opacity: 1;
        transform: translateX(0) translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateX(500px) translateY(250px);
      }
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 40px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(to right, var(--primary), var(--accent));
    }
    
    h1, h2, h3 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(to right, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .hidden {
      display: none;
    }
    
    .step {
      animation: fadeIn 0.8s ease;
    }
    
    .step p {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      color: var(--dark);
    }
    
    .input-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    
    label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      color: var(--dark);
      min-width: 120px;
    }
    
    input, select {
      padding: 12px 15px;
      border: 2px solid #e1e5eb;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 5px;
      transition: all 0.3s;
      width: 100%;
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
    }
    
    button {
      padding: 12px 25px;
      margin-top: 20px;
      cursor: pointer;
      display: block;
      margin-left: auto;
      margin-right: auto;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(106, 90, 205, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(106, 90, 205, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(45deg);
      transition: all 0.5s;
      opacity: 0;
    }
    
    button:hover::after {
      opacity: 1;
      transform: rotate(45deg) translate(10%, 10%);
    }
    
    .zodiac-display {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, rgba(240, 244, 248, 0.7) 0%, rgba(225, 229, 235, 0.7) 100%);
      border-radius: 10px;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    
    .zodiac-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(106, 90, 205, 0.05) 50%, transparent 70%);
      animation: shimmer 3s infinite linear;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .quiz-item {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
      backdrop-filter: blur(5px);
    }
    
    .quiz-question {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--dark);
    }
    
    .quiz-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    .quiz-option {
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid rgba(225, 229, 235, 0.7);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quiz-option:hover {
      border-color: var(--primary);
      background: rgba(240, 244, 255, 0.8);
      transform: translateX(5px);
    }
    
    .quiz-option.selected {
      border-color: var(--primary);
      background: rgba(230, 233, 255, 0.8);
    }
    
    #report p {
      margin: 15px 0;
      padding: 15px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
      backdrop-filter: blur(5px);
    }
    
    .fade-in {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }
    
    .flash {
      animation: flash 1.5s ease infinite alternate;
    }
    
    .progress-bar {
      height: 6px;
      background: rgba(225, 229, 235, 0.7);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 20px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      animation: progressShine 1.5s infinite;
    }
    
    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(500%); }
    }
    
    .reveal-content {
      text-align: center;
      padding: 20px;
    }
    
    .reveal-content p {
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .rating-star {
      font-size: 24px;
      color: #e1e5eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .rating-star.active {
      color: #ffc107;
      text-shadow: 0 0 10px rgba(255, 193, 7, 0.7);
    }
    
    .accuracy-rating {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    .rating-scale {
      display: flex;
      justify-content: space-between;
      max-width: 400px;
      margin: 15px auto;
    }
    
    .rating-label {
      font-size: 14px;
      color: #666;
    }

    .self-rating {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }

    .self-rating-question {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
    }

    .self-rating-stars {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }

    .self-rating-star {
      font-size: 28px;
      color: #e1e5eb;
      cursor: pointer;
      transition: all 0.3s;
      padding: 5px;
    }

    .self-rating-star.active {
      color: #ff6b6b;
      text-shadow: 0 0 15px rgba(255, 107, 107, 0.7);
      transform: scale(1.2);
    }

    .self-rating-labels {
      display: flex;
      justify-content: space-between;
      max-width: 450px;
      margin: 10px auto;
    }

    .self-rating-label {
      font-size: 12px;
      color: #666;
      text-align: center;
      flex: 1;
    }

    .progress-indicator {
      display: flex;
      justify-content: center;
      margin: 30px 0 20px 0;
      gap: 10px;
    }

    .progress-step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e1e5eb;
      transition: all 0.3s;
    }

    .progress-step.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    .progress-step.completed {
      background: var(--success);
    }

    .hint-text {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 15px 0;
      font-style: italic;
    }
    
    .analyzing-container {
      text-align: center;
      padding: 40px 20px;
    }
    
    .analyzing-text {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 30px;
    }
    
    .analyzing-dots {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .analyzing-dots div {
      position: absolute;
      top: 33px;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: var(--primary);
      animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }
    
    .analyzing-dots div:nth-child(1) {
      left: 8px;
      animation: analyzing-dots1 0.6s infinite;
    }
    
    .analyzing-dots div:nth-child(2) {
      left: 8px;
      animation: analyzing-dots2 0.6s infinite;
    }
    
    .analyzing-dots div:nth-child(3) {
      left: 32px;
      animation: analyzing-dots2 0.6s infinite;
    }
    
    .analyzing-dots div:nth-child(4) {
      left: 56px;
      animation: analyzing-dots3 0.6s infinite;
    }
    
    .zodiac-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    
    .report-category {
      margin: 25px 0;
      padding: 20px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 10px;
      backdrop-filter: blur(5px);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
    }
    
    .category-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .category-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--primary), transparent);
      margin: 20px 0;
    }
    
    .error-message {
      color: var(--error);
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    
    .success-message {
      color: var(--success);
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    .result-animation {
      animation: bounceIn 0.8s ease-out;
    }
    
    /* 統計區域樣式 */
    .statistics-section {
      text-align: center;
      margin: 30px 0;
      padding: 25px;
      background: rgba(248, 249, 250, 0.8);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(106, 90, 205, 0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-item {
      padding: 20px 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .stat-item:hover {
      transform: translateY(-5px);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .zodiac-comparison {
      margin-top: 30px;
      text-align: left;
    }

    .zodiac-comparison h4 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
    }

    .zodiac-comparison-content {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
    }

    .zodiac-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
    }

    .zodiac-stat-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .zodiac-name {
      font-weight: 600;
      color: var(--dark);
      min-width: 80px;
    }

    .zodiac-data {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .zodiac-data .stat {
      font-size: 13px;
      color: #666;
      background: rgba(106, 90, 205, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    /* 分享區域樣式 */
    .share-section {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: rgba(248, 249, 250, 0.7);
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    .share-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
    }
    
    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .share-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      color: white;
      min-width: 120px;
    }
    
    .share-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .share-facebook {
      background: #3b5998;
    }
    
    .share-twitter {
      background: #1da1f2;
    }
    
    .share-line {
      background: #00c300;
    }
    
    .share-copy {
      background: var(--primary);
    }
    
    .share-icon {
      font-size: 18px;
    }
    
    .share-result {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      text-align: left;
    }
    
    .share-result-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .share-result-text {
      font-size: 14px;
      color: var(--dark);
      line-height: 1.5;
    }
    
    /* 音效控制區域 */
    .audio-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .audio-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.3s;
    }
    
    .audio-btn:hover {
      transform: scale(1.1);
      background: var(--secondary);
    }
    
    .audio-btn.muted {
      background: #666;
    }
    
    .audio-slider {
      width: 100px;
      height: 5px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      outline: none;
      -webkit-appearance: none;
    }
    
    .audio-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }
    
    /* 真相揭開特效 */
    .truth-reveal-container {
      position: relative;
      overflow: hidden;
    }
    
    .truth-mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #6a5acd 0%, #9370db 50%, #ba55d3 100%);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
    }
    
    .truth-text {
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      text-align: center;
      text-shadow: 0 0 20px rgba(255,255,255,0.8);
      animation: truthPulse 2s infinite;
    }
    
    @keyframes truthPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .crack {
      position: absolute;
      background: white;
      z-index: 11;
      opacity: 0;
    }
    
    .crack-horizontal {
      width: 100%;
      height: 3px;
      left: 0;
    }
    
    .crack-vertical {
      width: 3px;
      height: 100%;
      top: 0;
    }
    
    .crack-diagonal-1 {
      width: 3px;
      height: 140%;
      transform: rotate(45deg);
      top: -20%;
    }
    
    .crack-diagonal-2 {
      width: 3px;
      height: 140%;
      transform: rotate(-45deg);
      top: -20%;
    }
    
    .shard {
      position: absolute;
      background: white;
      border-radius: 50%;
      z-index: 11;
      opacity: 0;
    }
    
    .reveal-content.truth-revealed {
      animation: contentReveal 1.5s ease-out;
    }
    
    @keyframes contentReveal {
      0% { 
        opacity: 0;
        transform: scale(0.8) rotate(-5deg);
      }
      100% { 
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }
    
    .truth-explosion {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      opacity: 0;
    }
    
    .glitch-text {
      position: relative;
      display: inline-block;
    }
    
    .glitch-text::before,
    .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .glitch-text::before {
      animation: glitch-1 0.5s infinite linear alternate-reverse;
      color: #ff00ff;
      z-index: -1;
    }
    
    .glitch-text::after {
      animation: glitch-2 0.5s infinite linear alternate-reverse;
      color: #00ffff;
      z-index: -2;
    }
    
    @keyframes glitch-1 {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    
    @keyframes glitch-2 {
      0% { transform: translate(0); }
      20% { transform: translate(2px, 2px); }
      40% { transform: translate(2px, -2px); }
      60% { transform: translate(-2px, 2px); }
      80% { transform: translate(-2px, -2px); }
      100% { transform: translate(0); }
    }
    
    .matrix-rain {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
      opacity: 0;
    }
    
    .rain-char {
      position: absolute;
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
      opacity: 0;
    }
    
    /* OG 圖片生成器樣式 */
    .og-generator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .og-generator.active {
      display: flex;
    }
    
    .og-generator-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes flash {
      0% { color: var(--primary); }
      50% { color: var(--accent); }
      100% { color: var(--primary); }
    }
    
    @keyframes analyzing-dots1 {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }
    
    @keyframes analyzing-dots3 {
      0% { transform: scale(1); }
      100% { transform: scale(0); }
    }
    
    @keyframes analyzing-dots2 {
      0% { transform: translate(0, 0); }
      100% { transform: translate(24px, 0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .input-group {
        flex-direction: column;
        align-items: center;
      }
      
      .rating-scale {
        flex-direction: column;
        gap: 10px;
      }

      .self-rating-stars {
        gap: 8px;
      }

      .self-rating-star {
        font-size: 24px;
      }

      .self-rating-labels {
        flex-direction: column;
        gap: 5px;
      }

      .progress-indicator {
        gap: 8px;
      }

      .progress-step {
        width: 10px;
        height: 10px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      .zodiac-stat-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .zodiac-data {
        width: 100%;
        justify-content: space-between;
      }
      
      .share-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .share-button {
        width: 100%;
        max-width: 200px;
      }
      
      .audio-controls {
        bottom: 10px;
        left: 10px;
      }
      
      .audio-slider {
        width: 80px;
      }
      
      .truth-text {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- 優化星空背景 -->
  <div class="stars-background" id="stars-background"></div>
  
  <!-- 星座連線 -->
  <div class="constellation" id="constellation"></div>
  
  <!-- 音效控制 -->
  <div class="audio-controls">
    <button class="audio-btn" id="audio-toggle" title="音效開關">♪</button>
    <input type="range" min="0" max="100" value="50" class="audio-slider" id="audio-volume">
  </div>
  
  <!-- 加載遮罩層 -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- 粒子爆炸容器 -->
  <div class="truth-explosion" id="truth-explosion"></div>
  
  <!-- 矩陣雨容器 -->
  <div class="matrix-rain" id="matrix-rain"></div>
  
  <!-- OG 圖片生成器 -->
  <div class="og-generator" id="og-generator">
    <div class="og-generator-content">
      <h3>生成 OG 預覽圖</h3>
      <canvas id="og-canvas" width="1200" height="630" style="border: 1px solid #ccc; max-width: 100%;"></canvas>
      <div style="margin-top: 20px; text-align: center;">
        <button onclick="downloadOGImage()" style="background: var(--success);">下載 OG 圖片</button>
        <button onclick="closeOGGenerator()" style="background: var(--error);">關閉</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>星座人格實驗</h1>
    
    <!-- 管理員工具（僅在開發時顯示） -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="generateOGImage()" style="background: var(--warning); font-size: 14px; padding: 8px 16px;">生成 OG 圖片</button>
    </div>
    
    <!-- 進度指示器 -->
    <div class="progress-indicator" id="progress-indicator">
      <div class="progress-step active" id="step1-indicator"></div>
      <div class="progress-step" id="step2-indicator"></div>
      <div class="progress-step" id="step3-indicator"></div>
      <div class="progress-step" id="step4-indicator"></div>
      <div class="progress-step" id="step5-indicator"></div>
      <div class="progress-step" id="step6-indicator"></div>
    </div>
    
    <!-- 步驟1：輸入生日 -->
    <div id="step-birthday" class="step">
      <p>請輸入您的生日，我們將為您分析星座特質：</p>
      <div class="input-group">
        <label>月份：
          <select id="birth-month">
            <option value="">請選擇</option>
            <option value="1">1月</option>
            <option value="2">2月</option>
            <option value="3">3月</option>
            <option value="4">4月</option>
            <option value="5">5月</option>
            <option value="6">6月</option>
            <option value="7">7月</option>
            <option value="8">8月</option>
            <option value="9">9月</option>
            <option value="10">10月</option>
            <option value="11">11月</option>
            <option value="12">12月</option>
          </select>
        </label>
        <label>日期：
          <select id="birth-day">
            <option value="">請選擇</option>
          </select>
        </label>
      </div>
      <div class="error-message" id="birthday-error"></div>
      <button onclick="submitBirthday()">確認星座</button>
    </div>

    <!-- 步驟2：顯示星座 -->
    <div id="step-zodiac" class="step hidden">
      <div class="zodiac-display">
        <h2 id="zodiac-name"></h2>
        <p id="zodiac-dates"></p>
      </div>
      <button onclick="startQuiz()">開始人格測驗</button>
    </div>

    <!-- 步驟3：測驗 -->
    <div id="step-quiz" class="step hidden">
      <h2>個人特質測驗</h2>
      <div class="progress-bar">
        <div class="progress" id="quiz-progress"></div>
      </div>
      <form id="quiz-form"></form>
      <button id="quiz-submit" onclick="submitQuiz()" class="hidden">完成測驗</button>
    </div>

    <!-- 步驟3.5：分析中 -->
    <div id="step-analyzing" class="step hidden">
      <div class="analyzing-container">
        <div class="zodiac-icon" id="analyzing-zodiac-icon">♋</div>
        <div class="analyzing-text">分析中<span id="analyzing-dots">...</span></div>
        <div class="analyzing-dots">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
        <p style="margin-top: 30px; color: #666;">正在為您生成專屬星座人格報告...</p>
      </div>
    </div>

    <!-- 步驟4：報告 -->
    <div id="step-report" class="step hidden">
      <h2>您的專屬星座人格報告</h2>
      <div id="report"></div>
      
      <!-- 這就是我評分 -->
      <div class="self-rating">
        <div class="self-rating-question">以上描述在多大程度上讓你覺得『這就是我』？</div>
        <div class="self-rating-stars" id="self-rating-stars">
          <div class="self-rating-star" onclick="rateSelf(1)">★</div>
          <div class="self-rating-star" onclick="rateSelf(2)">★</div>
          <div class="self-rating-star" onclick="rateSelf(3)">★</div>
          <div class="self-rating-star" onclick="rateSelf(4)">★</div>
          <div class="self-rating-star" onclick="rateSelf(5)">★</div>
        </div>
        <div class="self-rating-labels">
          <span class="self-rating-label">1分<br>最不符合</span>
          <span class="self-rating-label"></span>
          <span class="self-rating-label"></span>
          <span class="self-rating-label"></span>
          <span class="self-rating-label">5分<br>最符合</span>
        </div>
      </div>
      
      <!-- 測驗準確度評分 -->
      <div class="accuracy-rating">
        <h3>您覺得這個測驗的準確度如何？</h3>
        <div class="rating-stars" id="accuracy-stars">
          <div class="rating-star" onclick="rateAccuracy(1)">★</div>
          <div class="rating-star" onclick="rateAccuracy(2)">★</div>
          <div class="rating-star" onclick="rateAccuracy(3)">★</div>
          <div class="rating-star" onclick="rateAccuracy(4)">★</div>
          <div class="rating-star" onclick="rateAccuracy(5)">★</div>
        </div>
        <div class="rating-scale">
          <span class="rating-label">1分 - 不準</span>
          <span class="rating-label">5分 - 狠準</span>
        </div>
      </div>

      <!-- 錯誤提示 -->
      <div class="error-message" id="feedback-error"></div>
      <div class="success-message" id="feedback-success"></div>
      
      <!-- 提示文字 -->
      <div class="hint-text">完成評分後，記得按下揭密按鈕</div>
      
      <button onclick="submitFeedback()">提交反饋並揭密</button>
    </div>

    <!-- 步驟5：揭密頁 -->
    <div id="step-reveal" class="step hidden">
      <div class="truth-reveal-container">
        <!-- 真相遮罩層 -->
        <div class="truth-mask" id="truth-mask">
          <div class="truth-text">真相即將揭曉...</div>
          <!-- 裂痕效果 -->
          <div class="crack crack-horizontal" id="crack-1"></div>
          <div class="crack crack-vertical" id="crack-2"></div>
          <div class="crack crack-diagonal-1" id="crack-3"></div>
          <div class="crack crack-diagonal-2" id="crack-4"></div>
          <!-- 碎片 -->
          <div class="shard" id="shard-1"></div>
          <div class="shard" id="shard-2"></div>
          <div class="shard" id="shard-3"></div>
          <div class="shard" id="shard-4"></div>
        </div>
        
        <!-- 原有內容包裝在reveal-content中 -->
        <div class="reveal-content" id="reveal-content" style="opacity: 0;">
          <h2 class="glitch-text" data-text="揭密時間！">揭密時間！</h2>
          <p>其實，每個人看到的報告結果都是同一份通用報告 😉</p>
          <p>這個實驗的目的，是想讓你體驗一個有趣的心理學現象。</p>
          <p>人們往往會認為一些模糊、普遍性的人格描述非常準確地揭示了自己的特點，</p>
          <p>而實際上這些描述適用於很多人。</p>
          <p>感謝您參與這個心理實驗！</p>
          
          <button onclick="showStatistics()" style="margin: 20px 0;">查看真實統計數據</button>
          <button onclick="restartExperiment()">重新開始實驗</button>
        </div>
      </div>
    </div>

    <!-- 步驟6：統計數據頁 -->
    <div id="step-statistics" class="step hidden">
      <div class="reveal-content">
        <h2>📊 真實實驗數據統計</h2>
        <p>以下是所有參與者的真實評分數據（實時更新）：</p>
        
        <!-- 統計區域 -->
        <div class="statistics-section">
          <h3>整體統計</h3>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="total-participants">0</div>
              <div class="stat-label">總參與人數</div>
            </div>
            
            <div class="stat-item">
              <div class="stat-value" id="avg-self-rating">0.00</div>
              <div class="stat-label">平均「這就是我」評分</div>
            </div>
            
            <div class="stat-item">
              <div class="stat-value" id="avg-accuracy-rating">0.00</div>
              <div class="stat-label">平均準確度評分</div>
            </div>
            
            <div class="stat-item">
              <div class="stat-value" id="high-self-rating-percent">0%</div>
              <div class="stat-label">高認同度比例 (4-5分)</div>
            </div>
          </div>
          
          <div class="zodiac-comparison">
            <h4>各星座認同度比較</h4>
            <div id="zodiac-comparison-content" class="zodiac-comparison-content">
              <!-- 星座數據將在這裡動態生成 -->
            </div>
          </div>
        </div>

        <div class="category-divider"></div>
        
        <!-- 分享區域 -->
        <div class="share-section">
          <div class="share-title">分享這個有趣的實驗給朋友</div>
          <div class="share-buttons">
            <button class="share-button share-facebook" onclick="shareOnFacebook()">
              <span class="share-icon">f</span> Facebook
            </button>
            <button class="share-button share-twitter" onclick="shareOnTwitter()">
              <span class="share-icon">𝕏</span> Twitter
            </button>
            <button class="share-button share-line" onclick="shareOnLine()">
              <span class="share-icon">LINE</span> LINE
            </button>
            <button class="share-button share-copy" onclick="copyShareLink()">
              <span class="share-icon">📋</span> 複製連結
            </button>
          </div>
          
          <div class="share-result">
            <div class="share-result-title">我的實驗結果：</div>
            <div class="share-result-text" id="share-result-text">
              我剛剛完成了星座人格實驗，發現了一個有趣的心理學現象！原來每個人的星座報告都是一樣的，但我們卻覺得它特別準確。你也來試試看吧！
            </div>
          </div>
        </div>
        
        <button onclick="restartExperiment()" style="margin-top: 20px;">重新開始實驗</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCIn9yC8qBIrKNRvPkvCeNbSkkRLg3xqfU",
      authDomain: "zodiac-experiment.firebaseapp.com",
      projectId: "zodiac-experiment",
      storageBucket: "zodiac-experiment.firebasestorage.app",
      messagingSenderId: "932529210373",
      appId: "1:932529210373:web:56eba84e4b615bd382886c",
      measurementId: "G-JK860Q0MQH"
    };

    // 星座數據
    const zodiacSigns = [
      { name: "摩羯座", start: [12, 22], end: [1, 19], element: "土", symbol: "♑" },
      { name: "水瓶座", start: [1, 20], end: [2, 18], element: "風", symbol: "♒" },
      { name: "雙魚座", start: [2, 19], end: [3, 20], element: "水", symbol: "♓" },
      { name: "牡羊座", start: [3, 21], end: [4, 19], element: "火", symbol: "♈" },
      { name: "金牛座", start: [4, 20], end: [5, 20], element: "土", symbol: "♉" },
      { name: "雙子座", start: [5, 21], end: [6, 20], element: "風", symbol: "♊" },
      { name: "巨蟹座", start: [6, 21], end: [7, 22], element: "水", symbol: "♋" },
      { name: "獅子座", start: [7, 23], end: [8, 22], element: "火", symbol: "♌" },
      { name: "處女座", start: [8, 23], end: [9, 22], element: "土", symbol: "♍" },
      { name: "天秤座", start: [9, 23], end: [10, 22], element: "風", symbol: "♎" },
      { name: "天蠍座", start: [10, 23], end: [11, 21], element: "水", symbol: "♏" },
      { name: "射手座", start: [11, 22], end: [12, 21], element: "火", symbol: "♐" }
    ];

    // 測驗題目和選項
    const quizQuestions = [
      "當面對新環境時，你通常會：",
      "在社交場合中，你更傾向於：",
      "做決策時，你主要依賴：",
      "你認為自己最大的優點是：",
      "面對壓力時，你通常會：",
      "在團隊中，你通常扮演的角色是：",
      "你更喜歡的工作方式是：",
      "對於未來，你的態度是：",
      "在感情關係中，你重視的是：",
      "你認為成功的關鍵是：",
      "空閒時間，你更願意：",
      "對於批評，你的反應通常是：",
      "你認為自己最需要改進的是：",
      "在學習新事物時，你傾向於：",
      "你的人生哲學更接近："
    ];

    const quizOptions = [
      ["謹慎觀察，慢慢適應", "積極探索，快速融入", "隨遇而安，順其自然", "感到不安，需要支持"],
      ["主動結識新朋友", "與熟悉的人交流", "觀察他人，選擇性交流", "盡量避免社交互動"],
      ["邏輯分析", "直覺感受", "他人意見", "過往經驗"],
      ["責任感強", "創造力豐富", "善解人意", "適應力強"],
      ["制定計劃解決問題", "尋求他人幫助", "暫時逃避放鬆", "情緒化反應"],
      ["領導者", "協調者", "執行者", "創意提供者"],
      ["獨立完成", "團隊合作", "有明確指導", "自由發揮"],
      ["充滿期待，積極規劃", "隨緣面對，不強求", "有些擔憂，謹慎準備", "享受當下，不考慮太遠"],
      ["信任與忠誠", "溝通與理解", "激情與浪漫", "獨立與空間"],
      ["堅持與努力", "創意與靈感", "人際關係", "機會與運氣"],
      ["獨處思考", "與朋友相聚", "嘗試新活動", "休息放鬆"],
      ["認真反思", "辯解或防禦", "尋求解釋", "情緒低落"],
      ["過於完美主義", "缺乏行動力", "過於敏感", "不善表達"],
      ["系統性學習", "實踐中學習", "向他人請教", "憑興趣探索"],
      ["活在當下", "規劃未來", "追尋意義", "服務他人"]
    ];

    // 通用報告
    const universalReport = {
      title: "您的專屬星座人格特質報告",
      categories: [
        {
          title: "🌙 內在性格",
          items: [
            "1. 你是一個內心細膩、渴望被理解的人，雖然外表堅強，但只有少數人能走進你的世界。",
            "2. 你表面上社交自如，但心底卻喜歡獨處——這種反差讓你顯得神秘而難以捉摸。",
            "3. 你渴望與眾不同，卻也害怕被排斥，因此常在「做自己」與「被接納」之間搖擺。"
          ]
        },
        {
          title: "☀️ 目標與成長",
          items: [
            "4. 你對未來有很多夢想與計畫，只是偶爾也會被現實的壓力拉回地面。",
            "5. 你對自我要求高，常常反省與成長，因為你知道自己能比現在更好。"
          ]
        },
        {
          title: "💞 人際關係",
          items: [
            "6. 你在友情中真誠又重感情，只是有時也會懷疑對方是否像你一樣在乎。",
            "7. 你不喜歡被控制，卻又希望有人能給你安全感。",
            "8. 你曾經被誤解過，因此更懂得體諒別人的感受。"
          ]
        },
        {
          title: "🌊 情緒與感受",
          items: [
            "9. 你很有直覺，常能察覺別人情緒的細微變化，但這也容易讓你感到疲憊。",
            "10. 你面對選擇時會猶豫不決，不是因為不敢冒險，而是因為你真的在乎結果。"
          ]
        }
      ]
    };

    // 全局變量
    let accuracyRating = 0;
    let selfRating = 0;
    let currentZodiacSymbol = "♋";
    let currentStep = 1;
    let userZodiacName = "";
    let db = null;
    
    // 音效相關變量
    let audioEnabled = true;
    let audioVolume = 0.5;
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};

    // OG 圖片生成功能
    function generateOGImage() {
      const canvas = document.getElementById('og-canvas');
      const ctx = canvas.getContext('2d');
      
      // 清除畫布
      ctx.clearRect(0, 0, 1200, 630);
      
      // 背景漸層
      const gradient = ctx.createLinearGradient(0, 0, 1200, 630);
      gradient.addColorStop(0, '#667eea');
      gradient.addColorStop(0.5, '#764ba2');
      gradient.addColorStop(1, '#5a4fcf');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, 1200, 630);
      
      // 添加閃爍星星
      ctx.fillStyle = '#ffffff';
      for (let i = 0; i < 80; i++) {
        const x = Math.random() * 1200;
        const y = Math.random() * 630;
        const size = Math.random() * 2.5 + 0.5;
        const opacity = Math.random() * 0.8 + 0.2;
        
        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
      
      // 添加大星星（裝飾用）
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      for (let i = 0; i < 5; i++) {
        const x = 200 + Math.random() * 800;
        const y = 150 + Math.random() * 300;
        const size = Math.random() * 8 + 4;
        
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // 添加星座符號背景
      const zodiacSymbols = '♈♉♊♋♌♍♎♏♐♑♒♓';
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.font = 'bold 70px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(zodiacSymbols, 600, 180);
      
      // 添加主要標題
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 82px "Segoe UI", Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // 文字陰影
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      
      ctx.fillText('星座人格實驗', 600, 280);
      
      // 移除陰影
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      
      // 添加副標題
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.font = '42px "Segoe UI", Arial, sans-serif';
      ctx.fillText('心理學實驗測驗', 600, 360);
      
      // 添加呼籲行動按鈕效果
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
      ctx.beginPath();
      ctx.roundRect(450, 420, 300, 70, 35);
      ctx.fill();
      
      // 添加呼籲行動文字
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 32px "Segoe UI", Arial, sans-serif';
      ctx.fillText('揭開星座的真相', 600, 460);
      
      // 添加網址
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.font = '24px "Segoe UI", Arial, sans-serif';
      ctx.fillText('zodiac-experiment.com', 600, 550);
      
      // 顯示生成器
      document.getElementById('og-generator').classList.add('active');
      
      console.log('OG 圖片生成完成！');
    }

    function downloadOGImage() {
      const canvas = document.getElementById('og-canvas');
      const link = document.createElement('a');
      link.download = 'og-image.jpg';
      link.href = canvas.toDataURL('image/jpeg', 0.92);
      link.click();
      alert('OG 圖片已下載！請將檔案命名為 og-image.jpg 並上傳到您的網站 images 文件夾');
    }

    function closeOGGenerator() {
      document.getElementById('og-generator').classList.remove('active');
    }

    // 動態更新 OG 圖片 URL
    function updateOGImageURL() {
      const currentURL = window.location.href;
      const baseURL = currentURL.split('/').slice(0, -1).join('/');
      const ogImageURL = `${baseURL}/images/og-image.jpg`;
      
      document.getElementById('dynamic-og-image').content = ogImageURL;
      document.getElementById('dynamic-twitter-image').content = ogImageURL;
    }

    // Firebase 數據服務
    const FirebaseService = {
      db: null,
      isInitialized: false,

      async init() {
        try {
          // 初始化 Firebase
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.isInitialized = true;
          console.log('Firebase 初始化成功');
          return true;
        } catch (error) {
          console.error('Firebase 初始化失敗:', error);
          this.isInitialized = false;
          return false;
        }
      },

      async uploadData(ratingData) {
        if (!this.isInitialized) {
          console.warn('Firebase 未初始化，無法上傳數據');
          return false;
        }

        try {
          await this.db.collection('zodiac_ratings').add({
            ...ratingData,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: new Date().toISOString()
          });
          console.log('數據上傳成功');
          return true;
        } catch (error) {
          console.error('數據上傳失敗:', error);
          return false;
        }
      },

      async getStatistics() {
        if (!this.isInitialized) {
          console.warn('Firebase 未初始化，返回空數據');
          return this.getEmptyStatistics();
        }

        try {
          const snapshot = await this.db.collection('zodiac_ratings').get();
          const allData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          return this.calculateStatistics(allData);
        } catch (error) {
          console.error('獲取統計數據失敗:', error);
          return this.getEmptyStatistics();
        }
      },

      calculateStatistics(data) {
        if (data.length === 0) {
          return this.getEmptyStatistics();
        }

        const selfRatings = data.map(item => item.selfRating || 0);
        const accuracyRatings = data.map(item => item.accuracyRating || 0);
        
        // 按星座分組計算
        const zodiacStats = {};
        data.forEach(item => {
          const zodiac = item.zodiac || '未知';
          if (!zodiacStats[zodiac]) {
            zodiacStats[zodiac] = {
              selfRatings: [],
              accuracyRatings: [],
              count: 0
            };
          }
          zodiacStats[zodiac].selfRatings.push(item.selfRating);
          zodiacStats[zodiac].accuracyRatings.push(item.accuracyRating);
          zodiacStats[zodiac].count++;
        });
        
        // 計算統計結果
        const zodiacResults = {};
        Object.keys(zodiacStats).forEach(zodiac => {
          const stats = zodiacStats[zodiac];
          zodiacResults[zodiac] = {
            count: stats.count,
            avgSelf: this.calculateAverage(stats.selfRatings),
            avgAccuracy: this.calculateAverage(stats.accuracyRatings)
          };
        });
        
        return {
          totalParticipants: data.length,
          avgSelfRating: this.calculateAverage(selfRatings),
          avgAccuracyRating: this.calculateAverage(accuracyRatings),
          highSelfRatingPercent: this.calculateHighRatingPercent(selfRatings),
          zodiacStats: zodiacResults
        };
      },

      calculateAverage(numbers) {
        if (numbers.length === 0) return "0.00";
        const sum = numbers.reduce((acc, num) => acc + num, 0);
        return (sum / numbers.length).toFixed(2);
      },

      calculateHighRatingPercent(ratings) {
        if (ratings.length === 0) return "0.0";
        const highRatings = ratings.filter(rating => rating >= 4).length;
        return ((highRatings / ratings.length) * 100).toFixed(1);
      },

      getEmptyStatistics() {
        return {
          totalParticipants: 0,
          avgSelfRating: "0.00",
          avgAccuracyRating: "0.00",
          highSelfRatingPercent: "0.0",
          zodiacStats: {}
        };
      }
    };

    // 音效系統
    const AudioSystem = {
      // 初始化音效系統
      init() {
        this.loadSounds();
        this.setupAudioControls();
      },
      
      // 加載音效
      async loadSounds() {
        const soundTypes = ['click', 'hover', 'success', 'magic', 'star', 'transition'];
        
        for (const type of soundTypes) {
          try {
            audioBuffers[type] = await this.generateSound(type);
          } catch (error) {
            console.warn(`無法生成音效: ${type}`, error);
          }
        }
      },
      
      // 生成音效
      generateSound(type) {
        return new Promise((resolve) => {
          const buffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.5, audioContext.sampleRate);
          const data = buffer.getChannelData(0);
          
          switch(type) {
            case 'click':
              // 短促的點擊聲
              for (let i = 0; i < buffer.length; i++) {
                data[i] = Math.sin(2 * Math.PI * 800 * i / audioContext.sampleRate) * 
                         Math.exp(-i / (audioContext.sampleRate * 0.01));
              }
              break;
              
            case 'hover':
              // 懸停時的輕柔聲音
              for (let i = 0; i < buffer.length; i++) {
                data[i] = Math.sin(2 * Math.PI * 600 * i / audioContext.sampleRate) * 
                         Math.exp(-i / (audioContext.sampleRate * 0.05)) * 0.3;
              }
              break;
              
            case 'success':
              // 成功音效
              for (let i = 0; i < buffer.length; i++) {
                const t = i / audioContext.sampleRate;
                data[i] = Math.sin(2 * Math.PI * 523.25 * t) * Math.exp(-t * 3) +
                          Math.sin(2 * Math.PI * 659.25 * t) * Math.exp(-t * 4) * 0.7 +
                          Math.sin(2 * Math.PI * 783.99 * t) * Math.exp(-t * 5) * 0.5;
              }
              break;
              
            case 'magic':
              // 魔法音效
              for (let i = 0; i < buffer.length; i++) {
                const t = i / audioContext.sampleRate;
                data[i] = Math.sin(2 * Math.PI * 440 * t) * Math.exp(-t * 2) * 0.5 +
                          Math.sin(2 * Math.PI * 554.37 * t) * Math.exp(-t * 3) * 0.3 +
                          Math.sin(2 * Math.PI * 659.25 * t) * Math.exp(-t * 4) * 0.2;
              }
              break;
              
            case 'star':
              // 星星閃爍音效
              for (let i = 0; i < buffer.length; i++) {
                const t = i / audioContext.sampleRate;
                data[i] = Math.sin(2 * Math.PI * 1000 * t) * Math.exp(-t * 8) * 0.4 +
                          Math.sin(2 * Math.PI * 1200 * t) * Math.exp(-t * 10) * 0.3;
              }
              break;
              
            case 'transition':
              // 過渡音效
              for (let i = 0; i < buffer.length; i++) {
                const t = i / audioContext.sampleRate;
                data[i] = Math.sin(2 * Math.PI * 200 * (1 + t * 2) * t) * Math.exp(-t * 2);
              }
              break;
          }
          
          resolve(buffer);
        });
      },
      
      // 播放音效
      playSound(type) {
        if (!audioEnabled || !audioBuffers[type]) return;
        
        const source = audioContext.createBufferSource();
        const gainNode = audioContext.createGain();
        
        source.buffer = audioBuffers[type];
        gainNode.gain.value = audioVolume;
        
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        source.start();
      },
      
      // 設置音效控制
      setupAudioControls() {
        const toggleBtn = document.getElementById('audio-toggle');
        const volumeSlider = document.getElementById('audio-volume');
        
        toggleBtn.addEventListener('click', () => {
          audioEnabled = !audioEnabled;
          toggleBtn.classList.toggle('muted', !audioEnabled);
          this.playSound('click');
        });
        
        volumeSlider.addEventListener('input', (e) => {
          audioVolume = e.target.value / 100;
          this.playSound('hover');
        });
        
        // 為按鈕添加音效
        document.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON' && !e.target.id.includes('audio')) {
            this.playSound('click');
          }
        });
        
        // 為選項添加懸停音效
        document.addEventListener('mouseover', (e) => {
          if ((e.target.classList.contains('quiz-option') || 
               e.target.classList.contains('rating-star') ||
               e.target.classList.contains('self-rating-star')) && 
              !e.target.classList.contains('selected') && 
              !e.target.classList.contains('active')) {
            this.playSound('hover');
          }
        });
      }
    };

    // 真相揭開特效
    function startTruthReveal() {
      const mask = document.getElementById('truth-mask');
      const content = document.getElementById('reveal-content');
      const explosion = document.getElementById('truth-explosion');
      const matrixRain = document.getElementById('matrix-rain');
      
      // 播放特殊音效
      AudioSystem.playSound('magic');
      
      // 第一步：裂痕出現
      setTimeout(() => {
        createCracks();
        AudioSystem.playSound('star');
      }, 1000);
      
      // 第二步：裂痕擴散
      setTimeout(() => {
        expandCracks();
        AudioSystem.playSound('transition');
      }, 1500);
      
      // 第三步：爆炸效果
      setTimeout(() => {
        createExplosion();
        createMatrixRain();
        AudioSystem.playSound('success');
      }, 2500);
      
      // 第四步：遮罩破碎，內容顯示
      setTimeout(() => {
        mask.style.opacity = '0';
        mask.style.transform = 'scale(1.5) rotate(10deg)';
        mask.style.transition = 'all 1s ease-out';
        
        content.style.opacity = '1';
        content.classList.add('truth-revealed');
        
        // 啟動文字故障效果
        startGlitchEffect();
        
      }, 3000);
      
      // 第五步：清理特效元素
      setTimeout(() => {
        mask.remove();
        setTimeout(() => {
          explosion.innerHTML = '';
          matrixRain.innerHTML = '';
          matrixRain.style.opacity = '0';
        }, 2000);
      }, 4000);
    }

    // 創建裂痕
    function createCracks() {
      const cracks = [
        { id: 'crack-1', left: '50%', top: '30%' },
        { id: 'crack-2', left: '40%', top: '50%' },
        { id: 'crack-3', left: '50%', top: '50%' },
        { id: 'crack-4', left: '60%', top: '50%' }
      ];
      
      cracks.forEach(crack => {
        const element = document.getElementById(crack.id);
        element.style.left = crack.left;
        element.style.top = crack.top;
        element.style.opacity = '1';
        element.style.transition = 'all 0.5s ease-out';
      });
    }

    // 擴散裂痕
    function expandCracks() {
      document.getElementById('crack-1').style.width = '100%';
      document.getElementById('crack-2').style.height = '100%';
      document.getElementById('crack-3').style.height = '200%';
      document.getElementById('crack-4').style.height = '200%';
      
      // 創建碎片
      createShards();
    }

    // 創建碎片
    function createShards() {
      const shards = [
        { id: 'shard-1', left: '20%', top: '20%', size: '15px' },
        { id: 'shard-2', left: '80%', top: '30%', size: '20px' },
        { id: 'shard-3', left: '30%', top: '70%', size: '12px' },
        { id: 'shard-4', left: '70%', top: '80%', size: '18px' }
      ];
      
      shards.forEach(shard => {
        const element = document.getElementById(shard.id);
        element.style.left = shard.left;
        element.style.top = shard.top;
        element.style.width = shard.size;
        element.style.height = shard.size;
        element.style.opacity = '1';
        element.style.boxShadow = '0 0 10px 2px white';
      });
    }

    // 創建爆炸粒子
    function createExplosion() {
      const explosion = document.getElementById('truth-explosion');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // 隨機位置
        const left = 40 + Math.random() * 20;
        const top = 40 + Math.random() * 20;
        
        particle.style.left = `${left}%`;
        particle.style.top = `${top}%`;
        
        // 隨機顏色
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        
        // 隨機動畫
        const angle = Math.random() * 360;
        const distance = 50 + Math.random() * 100;
        const duration = 1 + Math.random() * 2;
        
        particle.style.animation = `
          particleExplode ${duration}s ease-out forwards
        `;
        
        particle.style.setProperty('--angle', `${angle}deg`);
        particle.style.setProperty('--distance', `${distance}px`);
        
        explosion.appendChild(particle);
      }
      
      // 添加CSS動畫
      if (!document.getElementById('particle-animation')) {
        const style = document.createElement('style');
        style.id = 'particle-animation';
        style.textContent = `
          @keyframes particleExplode {
            0% {
              opacity: 1;
              transform: translate(0, 0) scale(1);
            }
            100% {
              opacity: 0;
              transform: translate(
                calc(cos(var(--angle)) * var(--distance)),
                calc(sin(var(--angle)) * var(--distance))
              ) scale(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // 創建矩陣雨效果
    function createMatrixRain() {
      const matrixRain = document.getElementById('matrix-rain');
      matrixRain.style.opacity = '0.3';
      
      const chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
      const charCount = 100;
      
      for (let i = 0; i < charCount; i++) {
        const char = document.createElement('div');
        char.className = 'rain-char';
        char.textContent = chars[Math.floor(Math.random() * chars.length)];
        
        char.style.left = `${Math.random() * 100}%`;
        char.style.animationDelay = `${Math.random() * 5}s`;
        char.style.animation = `rainFall ${2 + Math.random() * 3}s linear infinite`;
        
        matrixRain.appendChild(char);
      }
      
      // 添加矩陣雨動畫
      if (!document.getElementById('matrix-animation')) {
        const style = document.createElement('style');
        style.id = 'matrix-animation';
        style.textContent = `
          @keyframes rainFall {
            0% {
              opacity: 0;
              transform: translateY(-100px);
            }
            10% {
              opacity: 1;
            }
            90% {
              opacity: 1;
            }
            100% {
              opacity: 0;
              transform: translateY(100vh);
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // 啟動文字故障效果
    function startGlitchEffect() {
      const glitchTexts = document.querySelectorAll('.glitch-text');
      glitchTexts.forEach(text => {
        text.style.animation = 'none';
        setTimeout(() => {
          text.style.animation = 'glitch-1 0.5s infinite linear alternate-reverse';
        }, 100);
      });
      
      // 5秒後停止故障效果
      setTimeout(() => {
        glitchTexts.forEach(text => {
          text.style.animation = 'none';
        });
      }, 5000);
    }

    // 在頁面加載時初始化
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('頁面加載完成，初始化...');
        
        const monthSelect = document.getElementById('birth-month');
        monthSelect.addEventListener('change', updateDayOptions);
        updateDayOptions();
        createStars();
        createConstellation();
        startShootingStars();
        updateProgressIndicator();
        
        // 初始化音效系統
        AudioSystem.init();
        
        // 初始化 Firebase
        try {
          await FirebaseService.init();
          console.log('系統初始化完成');
        } catch (error) {
          console.error('初始化過程中發生錯誤:', error);
        }
        
        // 更新 OG 圖片 URL
        updateOGImageURL();
    });

    // 更新日期選項
    function updateDayOptions() {
        const monthSelect = document.getElementById('birth-month');
        const daySelect = document.getElementById('birth-day');
        const selectedMonth = parseInt(monthSelect.value);
        
        daySelect.innerHTML = '<option value="">請選擇</option>';
        
        if (!selectedMonth) return;
        
        let daysInMonth = 31;
        if (selectedMonth === 2) {
            daysInMonth = 29;
        } else if ([4, 6, 9, 11].includes(selectedMonth)) {
            daysInMonth = 30;
        }
        
        for (let i = 1; i <= daysInMonth; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i + '日';
            daySelect.appendChild(option);
        }
    }

    // 更新進度指示器
    function updateProgressIndicator() {
        const steps = document.querySelectorAll('.progress-step');
        steps.forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 === currentStep) {
                step.classList.add('active');
            } else if (index + 1 < currentStep) {
                step.classList.add('completed');
            }
        });
    }

    // 創建星空背景
    function createStars() {
        const starsContainer = document.getElementById('stars-background');
        const starCount = 80;
        
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.classList.add('background-star');
            
            const size = Math.random() * 1.5 + 0.5;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            
            star.style.setProperty('--duration', `${8 + Math.random() * 12}s`);
            star.style.setProperty('--delay', `${Math.random() * 15}s`);
            
            starsContainer.appendChild(star);
        }
    }

    // 創建星座連線
    function createConstellation() {
        const constellation = document.getElementById('constellation');
        const lineCount = 6;
        
        for (let i = 0; i < lineCount; i++) {
            const line = document.createElement('div');
            line.classList.add('constellation-line');
            
            const x1 = Math.random() * 100;
            const y1 = Math.random() * 100;
            const length = 50 + Math.random() * 80;
            const angle = Math.random() * 360;
            
            line.style.left = `${x1}%`;
            line.style.top = `${y1}%`;
            line.style.width = `${length}px`;
            line.style.transform = `rotate(${angle}deg)`;
            line.style.animationDelay = `${Math.random() * 10}s`;
            
            constellation.appendChild(line);
        }
    }

    // 流星效果
    function startShootingStars() {
        setInterval(() => {
            createShootingStar();
        }, 8000);
    }

    function createShootingStar() {
        const shootingStar = document.createElement('div');
        shootingStar.classList.add('shooting-star');
        
        const startX = Math.random() * 100;
        const startY = Math.random() * 50;
        
        shootingStar.style.left = `${startX}%`;
        shootingStar.style.top = `${startY}%`;
        
        document.body.appendChild(shootingStar);
        
        shootingStar.style.animation = `shoot 2s linear forwards`;
        
        setTimeout(() => {
            shootingStar.remove();
        }, 2000);
    }

    // 錯誤處理
    function showError(message, elementId) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }
    }

    // 成功訊息
    function showSuccess(message, elementId) {
        const successElement = document.getElementById(elementId);
        if (successElement) {
            successElement.textContent = message;
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }
    }

    // 日期驗證
    function isValidDate(month, day) {
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        return day > 0 && day <= daysInMonth[month - 1];
    }

    // 加載狀態控制
    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    // 星座判斷
    function getZodiacSign(month, day) {
        for (let sign of zodiacSigns) {
            const [startM, startD] = sign.start;
            const [endM, endD] = sign.end;
            
            if (startM === 12 && endM === 1) {
                if ((month === 12 && day >= startD) || (month === 1 && day <= endD)) {
                    return sign;
                }
            } 
            else if (month === startM && day >= startD) {
                return sign;
            }
            else if (month === endM && day <= endD) {
                return sign;
            }
        }
        return null;
    }

    // 提交生日
    function submitBirthday() {
        const month = parseInt(document.getElementById("birth-month").value);
        const day = parseInt(document.getElementById("birth-day").value);
        
        if (!month || !day) {
            showError("請選擇完整的生日日期", "birthday-error");
            return;
        }
        
        if (!isValidDate(month, day)) {
            showError("請選擇有效的日期", "birthday-error");
            return;
        }
        
        const sign = getZodiacSign(month, day);
        if (!sign) {
            showError("無法確定星座，請檢查輸入的日期", "birthday-error");
            return;
        }
        
        showLoading();
        AudioSystem.playSound('magic');
        
        setTimeout(() => {
            const zodiacName = document.getElementById("zodiac-name");
            const zodiacDates = document.getElementById("zodiac-dates");
            
            zodiacName.innerHTML = `${sign.symbol} 獻給獨一無二的${sign.name} ${sign.symbol}`;
            zodiacName.classList.add("flash");
            
            zodiacDates.textContent = `${sign.start[0]}月${sign.start[1]}日 - ${sign.end[0]}月${sign.end[1]}日 | ${sign.element}象星座`;
            
            currentZodiacSymbol = sign.symbol;
            userZodiacName = sign.name;
            
            document.getElementById("step-birthday").classList.add("hidden");
            document.getElementById("step-zodiac").classList.remove("hidden");
            
            currentStep = 2;
            updateProgressIndicator();
            
            hideLoading();
            AudioSystem.playSound('success');
        }, 1000);
    }

    // 開始測驗
    function startQuiz() {
        const quizContainer = document.getElementById("quiz-form");
        quizContainer.innerHTML = "";
        
        for (let i = 0; i < quizQuestions.length; i++) {
            const div = document.createElement("div");
            div.className = "quiz-item";
            div.innerHTML = `
                <div class="quiz-question">${i+1}. ${quizQuestions[i]}</div>
                <div class="quiz-options">
                    ${quizOptions[i].map((option, idx) => 
                        `<div class="quiz-option" data-q="${i}" data-a="${idx}">${option}</div>`
                    ).join('')}
                </div>
            `;
            quizContainer.appendChild(div);
        }
        
        document.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', function() {
                const question = this.getAttribute('data-q');
                document.querySelectorAll(`.quiz-option[data-q="${question}"]`).forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                AudioSystem.playSound('star');
                updateQuizProgress();
            });
        });
        
        document.getElementById("step-zodiac").classList.add("hidden");
        document.getElementById("step-quiz").classList.remove("hidden");
        
        const items = document.querySelectorAll(".quiz-item");
        items.forEach((item, index) => {
            setTimeout(() => { 
                item.style.opacity = 1; 
                item.style.transform = "translateY(0)";
            }, index * 100);
        });
        
        updateQuizProgress();
        AudioSystem.playSound('transition');
        
        currentStep = 3;
        updateProgressIndicator();
    }

    // 更新測驗進度
    function updateQuizProgress() {
        const answered = document.querySelectorAll('.quiz-option.selected').length;
        const total = quizQuestions.length;
        const progress = (answered / total) * 100;
        
        document.getElementById('quiz-progress').style.width = `${progress}%`;
        
        if (answered === total) {
            document.getElementById('quiz-submit').classList.remove('hidden');
            AudioSystem.playSound('success');
        } else {
            document.getElementById('quiz-submit').classList.add('hidden');
        }
    }

    // 提交測驗
    function submitQuiz() {
        document.getElementById("step-quiz").classList.add("hidden");
        document.getElementById("step-analyzing").classList.remove("hidden");
        
        document.getElementById("analyzing-zodiac-icon").textContent = currentZodiacSymbol;
        
        AudioSystem.playSound('magic');
        
        setTimeout(showFinalReport, 3000);
        
        currentStep = 4;
        updateProgressIndicator();
    }

    // 顯示最終報告
    function showFinalReport() {
        document.getElementById("step-analyzing").classList.add("hidden");
        document.getElementById("step-report").classList.remove("hidden");
        
        const reportContainer = document.getElementById("report");
        reportContainer.innerHTML = `<h3>${universalReport.title}</h3>`;
        
        universalReport.categories.forEach((category, categoryIndex) => {
            const categoryDiv = document.createElement("div");
            categoryDiv.className = "report-category";
            
            const categoryTitle = document.createElement("div");
            categoryTitle.className = "category-title";
            categoryTitle.textContent = category.title;
            categoryDiv.appendChild(categoryTitle);
            
            category.items.forEach((item, itemIndex) => {
                const p = document.createElement("p");
                p.textContent = item;
                p.style.opacity = "0";
                p.style.transform = "translateY(20px)";
                p.style.transition = "all 0.6s ease";
                categoryDiv.appendChild(p);
                
                setTimeout(() => {
                    p.style.opacity = "1";
                    p.style.transform = "translateY(0)";
                    AudioSystem.playSound('star');
                }, (categoryIndex * 300) + (itemIndex * 200));
            });
            
            reportContainer.appendChild(categoryDiv);
            
            if (categoryIndex < universalReport.categories.length - 1) {
                const divider = document.createElement("div");
                divider.className = "category-divider";
                reportContainer.appendChild(divider);
            }
            
            setTimeout(() => {
                categoryDiv.style.opacity = "1";
                categoryDiv.style.transform = "translateY(0)";
            }, categoryIndex * 400);
        });
        
        AudioSystem.playSound('success');
    }

    // 這就是我評分
    function rateSelf(rating) {
        selfRating = rating;
        const stars = document.querySelectorAll('#self-rating-stars .self-rating-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
        AudioSystem.playSound('star');
    }

    // 測驗準確度評分
    function rateAccuracy(rating) {
        accuracyRating = rating;
        const stars = document.querySelectorAll('#accuracy-stars .rating-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
        AudioSystem.playSound('star');
    }

    // 提交反饋
    async function submitFeedback() {
        if (selfRating === 0) {
            showError("請先為『這就是我』評分", "feedback-error");
            return;
        }
        
        if (accuracyRating === 0) {
            showError("請先為測驗準確度評分", "feedback-error");
            return;
        }
        
        if (confirm(`您確定要提交評分嗎？\n『這就是我』: ${selfRating} 分\n測驗準確度: ${accuracyRating} 分`)) {
            showLoading();
            AudioSystem.playSound('magic');
            
            try {
                // 準備評分數據
                const ratingData = {
                    selfRating: selfRating,
                    accuracyRating: accuracyRating,
                    zodiac: userZodiacName,
                    userAgent: navigator.userAgent,
                    screenSize: `${screen.width}x${screen.height}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
                
                // 上傳數據到 Firebase
                const uploadSuccess = await FirebaseService.uploadData(ratingData);
                
                if (uploadSuccess) {
                    showSuccess("評分提交成功！", "feedback-success");
                } else {
                    showSuccess("評分提交完成（離線模式）", "feedback-success");
                }
                
                // 延遲一下讓用戶看到成功訊息
                setTimeout(() => {
                    document.getElementById("step-report").classList.add("hidden");
                    document.getElementById("step-reveal").classList.remove("hidden");
                    
                    // 啟動真相揭開特效
                    setTimeout(startTruthReveal, 500);
                    
                    currentStep = 5;
                    updateProgressIndicator();
                    
                    hideLoading();
                }, 1000);
                
            } catch (error) {
                console.error('提交過程中發生錯誤:', error);
                showError("提交過程中發生錯誤", "feedback-error");
                hideLoading();
            }
        }
    }

    // 顯示統計數據頁面
    async function showStatistics() {
        showLoading();
        AudioSystem.playSound('transition');
        
        try {
            const stats = await FirebaseService.getStatistics();
            updateStatisticsDisplay(stats);
            
            document.getElementById("step-reveal").classList.add("hidden");
            document.getElementById("step-statistics").classList.remove("hidden");
            
            currentStep = 6;
            updateProgressIndicator();
            
        } catch (error) {
            console.error('顯示統計數據時發生錯誤:', error);
            showError("無法載入統計數據", "feedback-error");
        } finally {
            hideLoading();
        }
    }

    // 更新統計顯示
    function updateStatisticsDisplay(stats) {
        document.getElementById('total-participants').textContent = stats.totalParticipants.toLocaleString();
        document.getElementById('avg-self-rating').textContent = stats.avgSelfRating;
        document.getElementById('avg-accuracy-rating').textContent = stats.avgAccuracyRating;
        document.getElementById('high-self-rating-percent').textContent = stats.highSelfRatingPercent + '%';
        
        // 顯示星座比較
        displayZodiacComparison(stats.zodiacStats);
        
        AudioSystem.playSound('success');
    }

    // 顯示星座比較
    function displayZodiacComparison(zodiacStats) {
        const container = document.getElementById('zodiac-comparison-content');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (Object.keys(zodiacStats).length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zodiac-stat-item';
            emptyMsg.innerHTML = '<div class="zodiac-name">暫無數據</div><div class="zodiac-data"><span class="stat">等待更多參與者</span></div>';
            container.appendChild(emptyMsg);
            return;
        }
        
        // 按参与人数排序
        const sortedZodiacs = Object.keys(zodiacStats).sort((a, b) => {
            return zodiacStats[b].count - zodiacStats[a].count;
        });
        
        sortedZodiacs.forEach(zodiac => {
            const stat = zodiacStats[zodiac];
            const item = document.createElement('div');
            item.className = 'zodiac-stat-item';
            
            item.innerHTML = `
                <div class="zodiac-name">${zodiac}</div>
                <div class="zodiac-data">
                    <span class="stat">${stat.count} 人</span>
                    <span class="stat">認同度: ${stat.avgSelf}</span>
                    <span class="stat">準確度: ${stat.avgAccuracy}</span>
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    // 分享功能
    function shareOnFacebook() {
        const text = document.getElementById('share-result-text').textContent;
        const url = window.location.href;
        const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank', 'width=600,height=400');
        AudioSystem.playSound('click');
    }

    function shareOnTwitter() {
        const text = document.getElementById('share-result-text').textContent;
        const url = window.location.href;
        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text + ' ' + url)}`;
        window.open(shareUrl, '_blank', 'width=600,height=400');
        AudioSystem.playSound('click');
    }

    function shareOnLine() {
        const text = document.getElementById('share-result-text').textContent;
        const url = window.location.href;
        const shareUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank', 'width=600,height=400');
        AudioSystem.playSound('click');
    }

    function copyShareLink() {
        const text = document.getElementById('share-result-text').textContent;
        const url = window.location.href;
        const shareText = `${text}\n\n${url}`;
        
        navigator.clipboard.writeText(shareText).then(() => {
            showSuccess('連結已複製到剪貼簿！', 'feedback-success');
            AudioSystem.playSound('success');
        }).catch(err => {
            console.error('複製失敗:', err);
            showError('複製失敗，請手動複製', 'feedback-error');
        });
    }

    // 重新開始實驗
    function restartExperiment() {
        // 重置所有表單和狀態
        document.getElementById('birth-month').value = '';
        document.getElementById('birth-day').innerHTML = '<option value="">請選擇</option>';
        document.getElementById('self-rating-stars').innerHTML = `
            <div class="self-rating-star" onclick="rateSelf(1)">★</div>
            <div class="self-rating-star" onclick="rateSelf(2)">★</div>
            <div class="self-rating-star" onclick="rateSelf(3)">★</div>
            <div class="self-rating-star" onclick="rateSelf(4)">★</div>
            <div class="self-rating-star" onclick="rateSelf(5)">★</div>
        `;
        document.getElementById('accuracy-stars').innerHTML = `
            <div class="rating-star" onclick="rateAccuracy(1)">★</div>
            <div class="rating-star" onclick="rateAccuracy(2)">★</div>
            <div class="rating-star" onclick="rateAccuracy(3)">★</div>
            <div class="rating-star" onclick="rateAccuracy(4)">★</div>
            <div class="rating-star" onclick="rateAccuracy(5)">★</div>
        `;
        
        // 重置評分
        accuracyRating = 0;
        selfRating = 0;
        currentZodiacSymbol = "♋";
        userZodiacName = "";
        
        // 回到第一步
        document.getElementById('step-statistics').classList.add('hidden');
        document.getElementById('step-reveal').classList.add('hidden');
        document.getElementById('step-birthday').classList.remove('hidden');
        
        currentStep = 1;
        updateProgressIndicator();
        
        AudioSystem.playSound('transition');
    }

    console.log('🌟 星座人格實驗已加載完成 - 包含完整的 OG 圖片生成功能');
  </script>
</body>
</html>